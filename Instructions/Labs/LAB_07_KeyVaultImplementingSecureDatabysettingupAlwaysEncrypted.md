---
lab:
  title: 07 — Key Vault (реализация безопасных данных путем настройки Always Encrypted)
  module: Module 01 - Implement and manage enforcement of cloud governance policies
---

# Лаборатория 07. Key Vault (реализация безопасных данных путем настройки Always Encrypted)

# Руководство по лаборатории учащихся

## Сценарий практической работы

Вам было предложено создать подтверждение концепции приложения, которое использует поддержку База данных SQL Azure для функций Always Encrypted. Все секреты и ключи, используемые в этом сценарии, должны храниться в Key Vault. Приложение должно быть зарегистрировано в идентификаторе Microsoft Entra, чтобы повысить уровень безопасности. Чтобы достичь этих целей, необходимо включить доказательство концепции:

- Создание Azure Key Vault и хранение ключей и секретов в хранилище.
- Создайте База данных SQL и шифрование содержимого столбцов в таблицах баз данных с помощью Always Encrypted.

>**Примечание.** Для всех ресурсов в этой лаборатории мы используем **регион "Восточная часть США** ". Убедитесь, что этот регион используется для занятий с помощью инструктора. 

Чтобы сосредоточиться на аспектах безопасности Azure, связанных с созданием этой концепции, вы начнете с автоматического развертывания шаблона ARM, настроив виртуальную машину с помощью Visual Studio 2019 и SQL Server Management Studio 19.

## Цели лаборатории

В этой лаборатории вы выполните следующие упражнения:

- Упражнение 1. Развертывание базовой инфраструктуры из шаблона ARM
- Упражнение 2. Настройка ресурса Key Vault с ключом и секретом
- Упражнение 3. Настройка базы данных SQL Azure и приложения на основе данных
- Упражнение 4. Демонстрация использования Azure Key Vault в шифровании базы данных SQL Azure

## Схема Key Vault

![Схема, показывающая поток процессов задач в этой лаборатории.](../media/key-vault-diagram.png)

## Instructions

## Файлы лаборатории:

- **\\Allfiles Labs\\\\10\\az-500-10_azuredeploy.json**

- **\\Allfiles Labs\\\\10\\program.cs**

### Общая оценка времени лаборатории: 60 минут

### Упражнение 1. Развертывание базовой инфраструктуры из шаблона ARM

В этом упражнении вы выполните следующие задачи.

- Задача 1. Развертывание виртуальной машины Azure и базы данных SQL Azure

#### Задача 1. Развертывание виртуальной машины Azure и базы данных SQL Azure

В этой задаче вы развернете виртуальную машину Azure, которая автоматически установит Visual Studio 2019 и SQL Server Management Studio 19 в рамках развертывания. 

1. Войдите в портал Azure**`https://portal.azure.com/`**.

    >**Примечание.** Войдите в портал Azure с помощью учетной записи, которая имеет роль владельца или участника в подписке Azure, которую вы используете для этой лаборатории.

2. В портал Azure в текстовом поле "Поиск ресурсов, служб и документов" в верхней части страницы портал Azure введите ****настраиваемый шаблон** и нажмите клавишу **ВВОД**.**

3. В колонке **"Настраиваемое развертывание** " щелкните **собственный шаблон в параметре редактора** .

4. В колонке **"Изменить шаблон**" щелкните **"Загрузить файл", найдите **\\файл** Allfiles Labs\\\\10\\az-500-10_azuredeploy.json** и нажмите кнопку **"Открыть**".

5. В колонке **"Изменить шаблон** " нажмите кнопку **"Сохранить**".

6. В колонке **"Настраиваемое развертывание" в **области** развертывания** убедитесь, что следующие параметры настроены (оставьте остальные значения по умолчанию):

   |Параметр|Значение|
   |---|---|
   |Отток подписок|Имя подписки Azure, используемой в этой лаборатории|
   |Группа ресурсов|Нажмите кнопку **"Создать"** и введите имя **AZ500Lab10-lod@lab.LabInstance.Id**|
   |Расположение|**Восточная часть США**|
   |Имя пользователя|**Студент**|
   |Пароль|**Используйте личный пароль, созданный в лаборатории 02 > упражнении 2 > задаче 1 > шаге 3.**|
   
    >**Примечание.** Хотя вы можете изменить учетные данные администратора, используемые для входа на виртуальную машину, вам не нужно.

    >**Примечание.** Чтобы определить регионы Azure, где можно подготовить виртуальные машины Azure, обратитесь к разделу [**https://azure.microsoft.com/en-us/regions/offers/**](https://azure.microsoft.com/en-us/regions/offers/)

8. Нажмите кнопку **"Рецензирование" и "Создать** " и подтвердите развертывание, нажав кнопку **"Создать** ". 

    >**Примечание.** Это инициирует развертывание виртуальной машины Azure и База данных SQL Azure, необходимых для этой лаборатории. 

    >**Примечание.** Не ожидайте завершения развертывания шаблона ARM, но вместо этого продолжайте следующее упражнение. Развертывание может занять от **20 до 25 минут**. 

#### Установка пользовательского шаблона az500-10-DB.json

1. В портал Azure в текстовом поле "Поиск ресурсов, служб и документов" в верхней части страницы портал Azure введите ****настраиваемый шаблон** и нажмите клавишу **ВВОД**.**

2. В колонке **"Настраиваемое развертывание** " щелкните **собственный шаблон в параметре редактора** .

3. В колонке **"Изменить шаблон** " щелкните **"Загрузить файл**", найдите **файл \Allfiles\Labs\10\az-500-10_DB.json** и нажмите кнопку **"Открыть**".

4. Убедитесь, что выбрана правильная группа ресурсов.

5. **Задайте для** пароля администратора тот же пароль, который использовался для предыдущего шага.

### Упражнение 2. Настройка ресурса Key Vault с ключом и секретом

>**Примечание.** Для всех ресурсов в этой лаборатории мы используем **регион "Восточная часть США".** Убедитесь, что с инструктором это регион, используемый для вашего класса. 

В этом упражнении вы выполните следующие задачи.

- Задача 1. Создание и настройка Key Vault
- Задача 2. Добавление ключа в Key Vault
- Задача 3. Добавление секрета в Key Vault

#### Задача 1. Создание и настройка Key Vault

В этой задаче вы создадите ресурс Azure Key Vault. Вы также настроите разрешения Azure Key Vault.

1. Откройте Cloud Shell, щелкнув первый значок (рядом с строкой поиска) в правом верхнем углу портал Azure. Если появится запрос, выберите **PowerShell** и **создайте хранилище**.

2. Убедитесь, что **PowerShell** выбран в раскрывающемся меню в левом верхнем углу панели Cloud Shell.

3. В сеансе PowerShell в области Cloud Shell выполните следующую команду, чтобы создать Azure Key Vault в группе **AZ500Lab10-lod@lab.LabInstance.Id**ресурсов. (Если вы выбрали другое имя для группы ресурсов этой лаборатории из задачи 1, используйте это имя для этой задачи. Имя Key Vault должно быть уникальным. Помните имя, выбранное вами. Вам потребуется это в рамках этой лаборатории.  

    ```powershell
    $kvName = 'az500kv' + $(Get-Random)

    $location = (Get-AzResourceGroup -ResourceGroupName 'AZ500Lab10-lod@lab.LabInstance.Id').Location

    New-AzKeyVault -VaultName $kvName -ResourceGroupName 'AZ500Lab10-lod@lab.LabInstance.Id' -Location $location -DisableRbacAuthorization
    ```

    >**Примечание**. Выходные данные последней команды будут отображать имя хранилища и универсальный код ресурса (URI). Универсальный код ресурса (URI) хранилища находится в формате `https://<vault_name>.vault.azure.net/`

4. Закройте область Cloud Shell. 

5. В портал Azure в текстовом поле поиска, служб и документов в верхней части страницы портал Azure введите ****группы** ресурсов и нажмите клавишу **ВВОД**.**

6. В колонке **"Группы ресурсов" в списке группы** ресурсов щелкните **AZ500Lab10-lod@lab.LabInstance.Id** запись (или другое имя, выбранное ранее для группы ресурсов).

7. В колонке "Группа ресурсов" щелкните запись, представляющую только что созданное хранилище ключей. 

8. В колонке Key Vault в **разделе "Обзор** " щелкните **"Политики** доступа" и нажмите кнопку " **Создать**".

9. В колонке **"Создание политики** доступа" укажите следующие параметры (оставьте все остальные со значениями по умолчанию): 

    |Параметр|Значение|
    |----|----|
    |Настроить при помощи шаблона (необязательно)|**Ключ, секрет и управление сертификатами**|
    |Разрешения ключей|Щелкните " **Выбрать все** " в общей сложности **9 выбранных** разрешений|
    |Разрешения ключей/криптографические операции|Нажмите кнопку " **Войти"** , в результате чего в общей сложности **1 выбранных** разрешений|
    |Разрешения секретов|Щелкните " **Выбрать все** " в общей сложности **7 выбранных** разрешений|
    |Разрешения на сертификацию|Нажмите кнопку **"Выбрать все** " в общей сложности **15 выбранных** разрешений|
    |Выбор субъекта|В колонке **"Субъект"** выберите учетную запись пользователя и нажмите кнопку **"Далее"**|
    |Приложение (необязательно)|Щелкните **Далее**|
    |Проверить и создать|Нажмите кнопку " **Создать"**|
    
    >**Примечание**. Предыдущая операция проверки и создания возвращается на страницу политик доступа, в которую перечислены приложения, электронная почта, разрешения ключа, разрешения секрета и разрешения сертификата.
      
#### Задача 2. Добавление ключа в Key Vault

В этой задаче вы добавите ключ в Key Vault и просмотрите сведения о ключе. 

1. В портал Azure откройте сеанс PowerShell в области Cloud Shell.

2. Убедитесь, что **PowerShell** выбран в раскрывающемся меню в верхнем левом углу области Cloud Shell.

3. В сеансе PowerShell в области Cloud Shell выполните следующую команду, чтобы добавить защищенный программным обеспечением ключ в Key Vault: 

    ```powershell
    $kv = Get-AzKeyVault -ResourceGroupName 'AZ500Lab10-lod@lab.LabInstance.Id'

    $key = Add-AZKeyVaultKey -VaultName $kv.VaultName -Name 'MyLabKey' -Destination 'Software'
    ```

    >**Примечание**. Имя ключа — **MyLabKey**

4. В сеансе PowerShell в области Cloud Shell выполните следующую команду, чтобы проверить, был создан ключ:

    ```powershell
    Get-AZKeyVaultKey -VaultName $kv.VaultName
    ```

5. В сеансе PowerShell в области Cloud Shell выполните следующие действия, чтобы отобразить идентификатор ключа:

    ```powershell
    $key.key.kid
    ```

6. Сведите к минимуму область Cloud Shell. 

7. Вернитесь в портал Azure в колонке Key Vault в **разделе "Объекты**" щелкните **"Ключи**".

8. В списке ключей щелкните **запись MyLabKey, а затем в **колонке MyLabKey**** щелкните запись, представляющую текущую версию ключа.

    >**Примечание.** Изучите сведения о созданном ключе.

    >**Примечание.** Вы можете ссылаться на любой ключ с помощью идентификатора ключа. Чтобы получить самую текущую версию, см. ссылку `https://<key_vault_name>.vault.azure.net/keys/MyLabKey` или получить конкретную версию с помощью: `https://<key_vault_name>.vault.azure.net/keys/MyLabKey/<key_version>`


#### Задача 3. Добавление секрета в Key Vault

1. Вернитесь на панель Cloud Shell.

2. В сеансе PowerShell в области Cloud Shell выполните следующую команду, чтобы создать переменную с безопасным строковым значением:

    ```powershell
    $secretvalue = ConvertTo-SecureString 'Pa55w.rd1234' -AsPlainText -Force
    ```

3.  В сеансе PowerShell в области Cloud Shell выполните следующую команду, чтобы добавить секрет в хранилище:

    ```powershell
    $secret = Set-AZKeyVaultSecret -VaultName $kv.VaultName -Name 'SQLPassword' -SecretValue $secretvalue
    ```

    >**Примечание.** Имя секрета — SQLPassword. 

4.  В сеансе PowerShell в области Cloud Shell выполните следующую команду, чтобы убедиться, что секрет был создан.

    ```powershell
    Get-AZKeyVaultSecret -VaultName $kv.VaultName
    ```

5. Сведите к минимуму область Cloud Shell. 

6. В портал Azure вернитесь к колонке Key Vault в **разделе "Объекты**" щелкните **"Секреты**".

7. В списке секретов щелкните **запись SQLPassword, а затем в **колонке SQLPassword**** щелкните запись, представляющую текущую версию секрета.

    >**Примечание.** Изучите сведения о созданном секрете.

    >**Примечание. Чтобы получить самую последнюю версию секрета, получить ссылку `https://<key_vault_name>.vault.azure.net/secrets/<secret_name>` или получить определенную версию, см.** ссылку`https://<key_vault_name>.vault.azure.net/secrets/<secret_name>/<secret_version>`


### Упражнение 3. Настройка базы данных SQL Azure и приложения на основе данных

В этом упражнении вы выполните следующие задачи.

- Задача 1. Включение клиентского приложения для доступа к службе База данных SQL Azure.
- Задача 2. Создание политики, разрешающую приложению доступ к Key Vault.
- Задача 3. Получение строки подключения базы данных SQL Azure ADO.NET 
- Задача 4. Вход на виртуальную машину Azure под управлением Visual Studio 2019 и SQL Management Studio 19
- Задача 5. Создание таблицы в База данных SQL и выбор столбцов данных для шифрования


#### Задача 1. Включение клиентского приложения для доступа к службе База данных SQL Azure. 

В этой задаче вы позволите клиентскому приложению получить доступ к службе База данных SQL Azure. Для этого необходимо настроить необходимую проверку подлинности и получить идентификатор приложения и секрет, который потребуется выполнить проверку подлинности приложения.

1. В портал Azure в текстовом поле "Поиск ресурсов, служб и документов **" в верхней части страницы** портал Azure введите ****"Регистрация приложений" и нажмите клавишу **ВВОД**.

2. В колонке **"Регистрация приложений** " нажмите кнопку **+Создать регистрацию**. 

3. В колонке **"Регистрация приложения** " укажите следующие параметры (оставьте все остальные со значениями по умолчанию):

    |Параметр|Значение|
    |----|----|
    |Имя.|**sqlApp**|
    |URI перенаправления (необязательно)|**Интернет** и **https://sqlapp**|

4. В колонке **"Регистрация приложения** " нажмите кнопку **"Зарегистрировать**". 

    >**Примечание.** После завершения регистрации браузер автоматически перенаправит вас в **колонку sqlApp** . 

5. В колонке **sqlApp** определите значение идентификатора **** приложения (клиента). 

    >**Примечание.** Запишите это значение. Он понадобится в следующей задаче.

6. В колонке sqlApp в разделе "Управление **" щелкните "**Сертификаты и секреты**".**** **

7. **В sqlApp | Колонка "Сертификаты и секреты" / **раздел "Секреты**** клиента", нажмите кнопку +**Создать секрет клиента**

8. **В области "Добавление секрета** клиента" укажите следующие параметры:

    |Параметр|значение|
    |----|----|
    |Описание|**Key1**|
    |Срок действия истекает|**12 месяцев**|
    
9. Нажмите кнопку **"Добавить** ", чтобы обновить учетные данные приложения.

10. **В sqlApp | Колонка "Сертификаты и секреты**" определяет значение **Key1**.

    >**Примечание.** Запишите это значение. Он понадобится в следующей задаче. 

    >**Примечание.** Перед переходом из колонки обязательно скопируйте значение**. После этого вы больше не можете получить его чистое текстовое значение.


#### Задача 2. Создание политики, разрешающую приложению доступ к Key Vault.

В этой задаче вы предоставите только что зарегистрированным приложениям разрешения на доступ к секретам, хранящимся в Key Vault.

1. В портал Azure откройте сеанс PowerShell в области Cloud Shell.

2. Убедитесь, что **PowerShell** выбран в раскрывающемся меню в верхнем левом углу области Cloud Shell.

3. В сеансе PowerShell в области Cloud Shell выполните следующую команду, чтобы создать переменную, сохраняющую **идентификатор** приложения (клиента), записанный в предыдущей задаче (замените `<Azure_AD_Application_ID>` заполнитель значением идентификатора **** приложения (клиента):
   
    ```powershell
    $applicationId = '<Azure_AD_Application_ID>'
    ```
4. В сеансе PowerShell в области Cloud Shell выполните следующую команду, чтобы создать переменную, сохраняющую имя Key Vault.
    ```
    $kvName = (Get-AzKeyVault -ResourceGroupName 'AZ500Lab10-lod@lab.LabInstance.Id').VaultName

    $kvName
    ```

5. В сеансе PowerShell в области Cloud Shell выполните следующие действия, чтобы предоставить разрешения в Key Vault приложению, зарегистрированном в предыдущей задаче:

    ```powershell
    Set-AZKeyVaultAccessPolicy -VaultName $kvName -ResourceGroupName AZ500Lab10-lod@lab.LabInstance.Id -ServicePrincipalName $applicationId -PermissionsToKeys get,wrapKey,unwrapKey,sign,verify,list
    ```

6. Закройте область Cloud Shell. 


#### Задача 3. Получение строки подключения базы данных SQL Azure ADO.NET 

Развертывание шаблона ARM в упражнении 1 подготовило экземпляр SQL Server Azure и базу данных SQL Azure с именем **medical** . Вы обновите пустой ресурс базы данных с новой структурой таблицы и выберите столбцы данных для шифрования.

1. В портал Azure в текстовом поле "Поиск ресурсов, служб и документов" в верхней части страницы портал Azure введите ****базы данных** SQL и нажмите клавишу **ВВОД**.**

2. В списке баз данных SQL щелкните **запись medical(<randomsqlservername>).**

    >**Примечание.** Если база данных не найдена, скорее всего, это означает, что развертывание, инициированное в упражнении 1, еще не завершено. Это можно проверить, перейдя в группуAZ500Lab10-lod@lab.LabInstance.Id ресурсов Azure "" (или выбранное имя) и выбрав **"Развертывания** " на панели "Параметры".  

3. В колонке базы данных SQL в **разделе "Параметры** " щелкните **строки** подключения. 

    >**Примечание.** Интерфейс включает строка подключения для ADO.NET, JDBC, ODBC, PHP и Go. 
   
4. **Запишите строка подключения строка подключения строка подключения ADO.NET ADO.NET (проверка подлинности** SQL). Оно понадобится вам позднее.

    >**Примечание.** При использовании строка подключения обязательно замените `{your_password}` заполнитель паролем, настроенным для развертывания в упражнении 1.

#### Задача 4. Вход на виртуальную машину Azure под управлением Visual Studio 2019 и SQL Management Studio 19

В этой задаче вы войдите на виртуальную машину Azure, которая была запущена в упражнении 1. Эта виртуальная машина Azure размещает Visual Studio 2019 и SQL Server Management Studio 19.

    >**Note**: Before you proceed with this task, ensure that the deployment you initiated in the first exercise has completed successfully. You can validate this by navigating to the blade of the Azure resource group "AZ500Lab10-lod@lab.LabInstance.Id" (or other name you chose) and selecting **Deployments** from the Settings pane.  

1. В портал Azure в текстовом поле "Поиск ресурсов, служб и документов" в верхней части страницы портал Azure введите ****виртуальные машины** и нажмите клавишу **ВВОД**.**

2. В списке Виртуальные машины показана **запись az500-10-vm1**. В колонке **az500-10-vm1** на **панели Essentials** запишите общедоступный **IP-адрес**. Вы будете использовать это позже. 

#### Задача 5. Создание таблицы в База данных SQL и выбор столбцов данных для шифрования

В этой задаче вы подключитесь к База данных SQL с помощью SQL Server Management Studio и создадите таблицу. Затем вы зашифруете два столбца данных с помощью автоматического создания ключа из Azure Key Vault. 

1. В портал Azure перейдите в колонку **** медицинской базы данных SQL, в **разделе Essentials** определите **имя** сервера (скопируйте в буфер обмена), а затем на панели инструментов щелкните **"Задать брандмауэр** сервера".  

    >**Примечание.** Запишите имя сервера. Позже в этой задаче потребуется имя сервера.

2. В колонке **параметров** брандмауэра прокрутите вниз до имени правила, нажмите кнопку **+Добавить правило** брандмауэра и укажите следующие параметры: 

    |Параметр|Значение|
    |---|---|
    |Имя правила|**Разрешить виртуальную машину Mgmt**|
    |Начальный IP-адрес|Общедоступный IP-адрес az500-10-vm1|
    |Конечный IP-адрес|Общедоступный IP-адрес az500-10-vm1|

3. Нажмите кнопку **"Сохранить"** , чтобы сохранить изменение и закрыть область подтверждения. 

    >**Примечание.** Это изменяет параметры брандмауэра сервера, позволяя подключениям к медицинской базе данных из общедоступного IP-адреса виртуальной машины Azure, развернутого в этой лаборатории.

4. Вернитесь к колонке **az500-10-vm1**, щелкните "Обзор **", затем нажмите кнопку ****"Подключиться" и в раскрывающемся меню нажмите кнопку **"Подключить**".** 

5. Скачайте файл RDP и используйте его для подключения к **виртуальной машине Azure az500-10-vm1** с помощью удаленного рабочего стола. При появлении запроса на проверку подлинности укажите следующие учетные данные:

    |Параметр|Значение|
    |---|---|
    |Имя пользователя|**Студент**|
    |Пароль|**Используйте личный пароль, созданный в лаборатории 02 > упражнении 1 > задаче 1 > шаге 9.**|
    
    >**Примечание.** Дождитесь загрузки сеанса удаленного рабочего стола и **диспетчер сервера**. Закройте диспетчер сервера. 

    >**Примечание.** Остальные шаги в этой лаборатории выполняются в сеансе удаленного рабочего стола для **виртуальной машины Azure az500-10-vm1** .

6. Установите [SQL Server Management Studio](https://learn.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?preserve-view=true&view=sql-server-2017) на **az500-10-vm1.** Виртуальные машины Azure.
 
7. Откройте **SQL Server Management Studio**.

8. **В диалоговом окне "Подключение к серверу**" укажите следующие параметры: 

    |Параметр|Значение|
    |---|---|
    |Тип сервера|**Ядро СУБД**|
    |Server Name (Имя сервера)|имя сервера, указанное ранее в этой задаче|
    |Проверка подлинности|**              Проверка подлинности SQL Server**              |
    |Имя пользователя|**Студент**|
    |Пароль|**Используйте личный пароль, созданный в лаборатории 02 > упражнении 2 > задаче 1 > шаге 3.**|

9. **В диалоговом окне "Подключение к серверу**" нажмите кнопку **"Подключиться**".

10. **В консоли SQL Server Management Studio** в **области обозреватель объектов** разверните папку **"Базы данных**".

11. **В области обозреватель объектов** щелкните правой кнопкой мыши **медицинскую** базу данных и нажмите кнопку **"Создать запрос**".

12. Вставьте следующий код в окно запроса и нажмите кнопку **"Выполнить**". При этом будет создана **таблица пациентов** .

     ```sql
     CREATE TABLE [dbo].[Patients](
        [PatientId] [int] IDENTITY(1,1),
        [SSN] [char](11) NOT NULL,
        [FirstName] [nvarchar](50) NULL,
        [LastName] [nvarchar](50) NULL,
        [MiddleName] [nvarchar](50) NULL,
        [StreetAddress] [nvarchar](50) NULL,
        [City] [nvarchar](50) NULL,
        [ZipCode] [char](5) NULL,
        [State] [char](2) NULL,
        [BirthDate] [date] NOT NULL 
     PRIMARY KEY CLUSTERED ([PatientId] ASC) ON [PRIMARY] );
     ```
13. После успешного **создания таблицы в **области обозреватель объектов** разверните узел медицинской** базы данных, **узел таблиц**, щелкните правой кнопкой мыши **dbo. Узел пациентов** и нажмите кнопку **"Зашифровать столбцы**". 

    >**Примечание.** Это запустит **мастер Always Encrypted** .

14. На странице **Введение** нажмите кнопку **Далее**.

15. **На странице выбора** столбцов выберите **столбцы SSN** и **рождения**, задайте **тип **** шифрования столбца **SSN** детерминированным** и **столбец Рождения** на **случайный** и нажмите кнопку **"Далее**".

    >**Примечание.** При выполнении шифрования, если возникла ошибка, вызванная **исключением, была вызвана целевым объектом вызова**, связанного с **Ротари (Microsoft.SQLServer.Management.ServiceManagement),** убедитесь **, что значения **разрешений** ключа для операций****** политики поворота сняты, если не в портал Azure перейдите к **разрешениям ключей политики доступа >> ****Key Vault.** >> **** >> снять флажок со всеми значениями в разделе **Операции** политики поворота >> в **разделе "Операции** с привилегированными ключами" >> снять флажок **выпуска**.

16. **На странице "Конфигурация** главного ключа" выберите **Azure Key Vault**, нажмите кнопку **"Войти**", когда появится запрос, пройти проверку подлинности с помощью той же учетной записи пользователя, которую вы использовали для подготовки экземпляра Azure Key Vault ранее в этой лаборатории, убедитесь, что Key Vault появится в **раскрывающемся списке "Выбор Azure Key Vault**" и нажмите кнопку **"Далее**".

17. **На странице "Параметры запуска"** нажмите кнопку **"Далее**".
    
18. **На странице "Сводка**" нажмите кнопку **"Готово**", чтобы продолжить шифрование. При появлении запроса войдите снова с помощью той же учетной записи пользователя, которую вы использовали для подготовки экземпляра Azure Key Vault ранее в этой лаборатории.

19. После завершения процесса шифрования на **странице результатов** нажмите кнопку **"Закрыть**".

20. **В консоли SQL Server Management Studio** в **области** **обозреватель объектов** на медицинском узле разверните **вложенные разделы "Безопасность**" и **"Ключи** Always Encrypted". 

    >**Примечание**. Поднодер **"Ключи Always Encrypted"** содержат вложенную **папку "Основные ключи** столбца" и **"Ключи** шифрования столбцов".

### Упражнение 4. Демонстрация использования Azure Key Vault в шифровании базы данных SQL Azure

В этом упражнении вы выполните следующие задачи.

- Задача 1. Установка Visual Studio 2022
- Задача 2. Запуск приложения на основе данных для демонстрации использования Azure Key Vault в шифровании базы данных SQL Azure

#### Задача 1. Установка Visual Studio 2022

1. Переключитесь на виртуальную машину сервера, если вы еще не там.

2. Откройте диспетчер серверов.

3. Выберите локальные серверы.

4. Установите **для конфигурации** расширенной безопасности IE значение Off****.

5. Откройте браузер и обошли предупреждение об отключенном отключении IE ESC.

6. Переход к https://visualstudio.microsoft.com/downloads.

7. **В поле Visual Studio 2022** в разделе **"Сообщество**" выберите **"Бесплатный скачивание**".

8. Когда скачивание завершится, нажмите кнопку **"Открыть файл**".

9. Нажмите кнопку "Продолжить запуск установки".
  - Установка занимает около 10 минут

10. Выберите **.Net Desktop Development** на экране рабочих нагрузок.

#### Задача 2. Запуск приложения на основе данных для демонстрации использования Azure Key Vault в шифровании базы данных SQL Azure

Консольное приложение будет создано с помощью Visual Studio для загрузки данных в зашифрованные столбцы, а затем безопасного доступа к этим данным с помощью строка подключения, которая обращается к ключу в Key Vault.

1. С сеанса RDP до az500-10-vm1** запустите **Visual Studio 2019** из **меню **.**

2. Перейдите в окно с приветственным сообщением Visual Studio 2019, нажмите кнопку **входа** и при появлении запроса укажите учетные данные, используемые для проверки подлинности в подписке Azure, которую вы используете в этой лаборатории.

3. **На странице "Начало работы"** нажмите кнопку **"Создать проект**". 

4. В списке шаблонов проектов найдите **консольное приложение (платформа .NET Framework)**, в списке результатов щелкните **консольное приложение (платформа .NET Framework)** для **C#**, а затем нажмите кнопку **"Далее**".

5. **На странице "Настройка нового проекта**" укажите следующие параметры (оставьте другие параметры значениями по умолчанию), а затем нажмите кнопку **"Создать**".

    |Параметр|Значение|
    |---|---|
    |Имя проекта|**OpsEncrypt**|
    |Имя решения|**OpsEncrypt**|
    |Платформа|**.NET Framework 4.7.2**|

6. В консоли Visual Studio щелкните **меню "Сервис"** в раскрывающемся меню, выберите **NuGet диспетчер пакетов** и в каскадном меню щелкните **диспетчер пакетов консоль**.

7. **В области консоли** диспетчер пакетов выполните следующие действия, чтобы установить первый необходимый **пакет NuGet**:

    ```powershell
    Install-Package Microsoft.SqlServer.Management.AlwaysEncrypted.AzureKeyVaultProvider
    ```

8. **В области консоли** диспетчер пакетов выполните следующую команду, чтобы установить второй необходимый **пакет NuGet**:

    ```powershell
    Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory
    ```
    
9. Сведите к минимуму сеанс RDP на виртуальную машину Azure, а затем перейдите к **\\Allfiles Labs\\\\10\\program.cs**, откройте его в Блокноте и скопируйте его содержимое в буфер обмена.

10. Вернитесь к сеансу RDP и в консоли Visual Studio в **окне Обозреватель решений** щелкните **Program.cs** и замените его содержимое кодом, скопированным в буфер обмена.

11. В окне Visual Studio в **области Program.cs** в строке 15 замените `<connection string noted earlier>` заполнитель базой данных **SQL Azure ADO.NET строка подключения**, записанные ранее в лаборатории. В строка подключения замените `{your_password}` заполнитель паролем, указанным в развертывании в упражнении 1. Если вы сохранили строку на компьютере лаборатории, может потребоваться оставить сеанс RDP, чтобы скопировать строку ADO, а затем вернуться на виртуальную машину Azure, чтобы вставить ее.

12. В окне Visual Studio в **области Program.cs** в строке 16 замените `<client id noted earlier>` заполнитель значением **идентификатора** приложения (клиента) зарегистрированного приложения, записанного ранее в лаборатории. 

13. В окне Visual Studio в **области Program.cs** в строке 17 замените `<key value noted earlier>` заполнитель значением **Key1** зарегистрированного приложения, записанного ранее в лаборатории. 

14. В консоли Visual Studio нажмите кнопку **"Пуск** ", чтобы инициировать сборку консольного приложения и запустить ее.

15. Приложение запустит окно командной строки. При появлении запроса на ввод пароля введите пароль, указанный в развертывании в упражнении 1, чтобы подключиться к База данных SQL Azure. 

16. Оставьте консольное приложение запущенным и переключитесь на **консоль SQL Management Studio** . 

17. **В области обозреватель объектов** щелкните правой кнопкой мыши медицинскую базу данных** и в меню правой кнопкой мыши **щелкните **"Создать запрос**".

18. В окне запроса выполните следующий запрос, чтобы убедиться, что данные, загруженные в базу данных из консольного приложения, шифруются.

    ```sql
    SELECT FirstName, LastName, SSN, BirthDate FROM Patients;
    ```

19. Вернитесь в консольное приложение, в котором вам будет предложено ввести допустимый SSN. Это запросит зашифрованный столбец для данных. В командной строке введите следующее и нажмите клавишу ВВОД:

    ```cmd
    999-99-0003
    ```

    >**Примечание.** Убедитесь, что данные, возвращаемые запросом, не шифруются.

20. Чтобы завершить консольное приложение, нажмите клавишу ВВОД

**Очистка ресурсов**

> Не забудьте удалить все новые ресурсы Azure, которые больше не используются. Удаление неиспользуемых ресурсов гарантирует, что вы не будете нести непредвиденные затраты.

1. В портал Azure откройте Cloud Shell, щелкнув первый значок в правом верхнем углу портал Azure. 

2. В раскрывающемся меню в верхнем левом углу области Cloud Shell при необходимости выберите **PowerShell** и при появлении запроса нажмите кнопку **"Подтвердить**".

3. В сеансе PowerShell в области Cloud Shell выполните следующие действия, чтобы удалить группы ресурсов, созданные в этой лаборатории:
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500Lab10-lod@lab.LabInstance.Id" -Force -AsJob
    ```

4.  Закройте область **Cloud Shell**. 
