---
lab:
  title: 04. Настройка и защита ACR и AKS
  module: 'Module 01 - Secure compute, storage, and databases'
---

# Лаборатория 04. Настройка и защита ACR и AKS
# Руководство по лаборатории учащихся

## Сценарий практической работы

Вам было предложено развернуть доказательство концепции с Реестр контейнеров Azure и Служба Azure Kubernetes. В частности, доказательство концепции должно продемонстрировать:

- Использование Dockerfile для создания образа.
- Использование Реестр контейнеров Azure для хранения изображений.
- Настройка Служба Azure Kubernetes.
- Защита и доступ к приложениям контейнеров как внутри, так и во внешней среде. 

> Для всех ресурсов в этой лаборатории мы используем **регион "Восточная часть США** ". Убедитесь, что этот регион используется для занятий с помощью инструктора. 

## Цели лаборатории

В этой лаборатории вы завершите следующее упражнение:

- Упражнение 1. Настройка и защита ACR и AKS

## Настройка и защита схемы ACR и AKS

![Схема, показывающая поток процессов задач в этой лаборатории.](../media/configuring-and-securing-acr-and-aks-diagram.png)

## Instructions

## Файлы лаборатории:

- **\\Allfiles\\Labs\\09\\nginxexternal.yaml**
- **\\Allfiles\\Labs\\09\\nginxinternal.yaml**

### Упражнение 1. Настройка и защита ACR и AKS

### Предполагаемое время: 45 минут

> Для всех ресурсов в этой лаборатории мы используем **регион "Восточная часть США".** Убедитесь, что с инструктором это регион, используемый для вашего класса. 

В этом упражнении вы выполните следующие задачи.

- Задача 1. Создание Реестр контейнеров Azure
- Задача 2. Создание Файла Dockerfile, создание контейнера и отправка его в Реестр контейнеров Azure
- Задача 3. Создание кластера Служба Azure Kubernetes
- Задача 4. Предоставление разрешений кластера AKS для доступа к ACR
- Задача 5. Развертывание внешней службы в AKS
- Задача 6. Проверка доступа к внешней службе, размещенной в AKS
- Задача 7. Развертывание внутренней службы в AKS
- Задача 8. Проверка доступа к внутренней службе, размещенной в AKS

#### Задача 1. Создание Реестр контейнеров Azure

В этой задаче вы создадите группу ресурсов для лаборатории и Реестр контейнеров Azure.

1. Войдите в портал Azure**`https://portal.azure.com/`**.

    >**Примечание**. Войдите в портал Azure с помощью учетной записи, которая имеет роль владельца или участника в подписке Azure, которую вы используете для этой лаборатории, и роль глобального администратора в клиенте Microsoft Entra, связанном с этой подпиской.

2. В портал Azure откройте Cloud Shell, щелкнув первый значок в правом верхнем углу портала Azure. Если появится запрос, нажмите кнопку **Bash**, **не требуется** учетная запись хранения, выберите свою *подписку* и нажмите кнопку **"Применить**".

3. Убедитесь, что **Bash** выбран в раскрывающемся меню в левом верхнем углу панели Cloud Shell.

4. В сеансе Bash в области Cloud Shell выполните следующую команду, чтобы создать новую группу ресурсов для этой лаборатории:

    ```sh
    az group create --name AZ500LAB09 --location eastus
    ```

5. В сеансе Bash в области Cloud Shell выполните следующую команду, чтобы проверить, была создана группа ресурсов:

    ```
    az group list --query "[?name=='AZ500LAB09']" -o table
    ```

6. В сеансе Bash выполните следующие команды, чтобы зарегистрировать **регистрацию** контейнера в лабораторной среде.

   ```sh
   az provider register --namespace Microsoft.Kubernetes
   az provider register --namespace Microsoft.KubernetesConfiguration
   az provider register --namespace Microsoft.OperationsManagement
   az provider register --namespace Microsoft.OperationalInsights
   az provider register --namespace Microsoft.ContainerService
   az provider register --namespace Microsoft.ContainerRegistry
   ```

7. В сеансе Bash в области Cloud Shell выполните следующую команду, чтобы создать новый экземпляр Реестр контейнеров Azure (ACR) (имя ACR должно быть глобально уникальным): 

    ```sh
    az acr create --resource-group AZ500LAB09 --name az500$RANDOM$RANDOM --sku Basic
    ```

8. В сеансе Bash в области Cloud Shell выполните следующие действия, чтобы убедиться, что создан новый ACR:

    ```sh
    az acr list --resource-group AZ500LAB09 -o table
    ```

    >**Примечание.** Запишите имя ACR. Он понадобится в следующей задаче.

#### Задача 2. Создание Файла Dockerfile, создание контейнера и отправка его в Реестр контейнеров Azure

В этой задаче вы создадите Dockerfile, создадите образ из Dockerfile и развернете образ в ACR. 

1. В сеансе Bash в области Cloud Shell выполните следующие действия, чтобы создать Dockerfile для создания образа на основе Nginx: 

    ```sh
    echo FROM nginx > Dockerfile
    ```

2. В сеансе Bash в области Cloud Shell выполните следующую команду, чтобы создать образ из Dockerfile и отправить изображение в новый ACR. 

    >**Примечание.** Конечный период в конце командной строки является обязательным. Он обозначает текущий каталог как расположение Dockerfile. 

    ```sh
    ACRNAME=$(az acr list --resource-group AZ500LAB09 --query '[].{Name:name}' --output tsv)

    az acr build --resource-group AZ500LAB09 --image sample/nginx:v1 --registry $ACRNAME --file Dockerfile .
    ```

    >**Примечание.** Дождитесь успешного завершения команды. Это может занять около 2 минут.

3. Закройте область Cloud Shell.

4. В портал Azure перейдите к **группе ресурсов AZ500Lab09** и в списке ресурсов щелкните запись, представляющую экземпляр Реестр контейнеров Azure, подготовленный в предыдущей задаче.

5. В колонке реестра контейнеров в **разделе "Службы** " щелкните **Репозитории**. 

6. Убедитесь, что список репозиториев содержит новый образ контейнера с именем **sample/nginx**.

7. **Щелкните запись sample/nginx** и проверьте наличие тега версии 1 **, определяющего **версию образа.

8. **Щелкните запись версии 1**, чтобы просмотреть манифест изображения.

    >**Примечание.** Манифест включает дайджест sha256, дату создания манифеста и записи платформы. 

#### Задача 3. Создание кластера Служба Azure Kubernetes

В этой задаче вы создадите службу Azure Kubernetes и просмотрите развернутые ресурсы. 

1. В портал Azure в текстовом поле "Поиск ресурсов, служб и документов" в **верхней части страницы** портал Azure введите +++Kubernetes services+++ и нажмите **клавишу ВВОД**.

2. В колонке **служб** Kubernetes нажмите кнопку +Создать** и в раскрывающемся меню щелкните **+**Создать кластер Kubernetes.**

3. **На вкладке "Основы**" **колонки "Создание кластера Kubernetes" выберите предварительно заданную конфигурацию** кластера**, выберите ****"Разработка и тестирование" ($).** Теперь укажите следующие параметры (оставьте остальных со значениями по умолчанию):

    |Параметр|Значение|
    |----|----|
    | Отток подписок | *Используйте имя подписки Azure, используемой в этой лаборатории* |
    | Группа ресурсов | **AZ500LAB09** |
    | Предварительно заданная конфигурация кластера | **Разработка и тестирование** |
    | Имя кластера Kubernetes | +++MyKubernetesCluster+++ |
    | Область/регион | **Восточная часть США (США)** |
    | Менеджер по флоту | **Не допускается** |
    | Зоны доступности | **Не допускается** |
    | Ценовая категория AKS | **Бесплатно** |
    | Включение долгосрочной поддержки | **Флажок снят** |
    | Версия Kubernetes | *Использовать значение по умолчанию* |
    | Автоматическое обновление | *Сохранить значение по умолчанию * |
    | Тип канала безопасности узла | *Сохранение значения по умолчанию* |
    | Аутентификация и авторизация | **Локальные учетные записи с помощью RBAC Kubernetes** |

4. Нажмите кнопку "Далее **" и на **** вкладке **"Пулы** узлов" в колонке "Создание кластера** Kubernetes" укажите следующие параметры (оставьте остальные значения по умолчанию):

    |Параметр|Значение|
    |----|----|
    | Включение автоматической подготовки узла | **Снять флажок** |
    | Включение виртуальных узлов | **Снять флажок** |
    | Другие значения | *Сохранение значений по умолчанию* |

5. Нажмите кнопку " **Далее**", чтобы перейти к **сети**. 

    >**Примечание**. Появится всплывающее окно с сообщением о том, что **рекомендация** доступна для размера виртуальной машины.  **Примите рекомендацию** , чтобы перейти вперед.

6. На вкладке **"Сеть"** колонки **"Создание кластера** Kubernetes" укажите следующие параметры (оставьте остальных со значениями по умолчанию):

    |Параметр|Значение|
    |----|----|
    | Включение частного кластера | **Флажок снят** |
    | Настройка авторизованных диапазонов IP-адресов | **Флажок снят** |
    | Сетевая конфигурация | **Наложение Azure CNI** |
    | Префикс DNS-имени | **Оставьте значение по умолчанию** |
    | Политика сети | **Не допускается** |

    >**Примечание.** AKS можно настроить как частный кластер. Это назначает частный IP-адрес серверу API, чтобы гарантировать, что сетевой трафик между сервером API и пулами узлов остается только в частной сети. Дополнительные сведения см[. на странице создания частной Служба Azure Kubernetes кластера](https://docs.microsoft.com/en-us/azure/aks/private-clusters).

7. Нажмите кнопку **"Далее**" и **на вкладке **"Интеграции"** на странице "Создание кластера** Kubernetes" оставьте **все значения по умолчанию**. 

    >**Примечание.** В рабочих сценариях необходимо включить мониторинг. Мониторинг отключен в этом случае, так как он не рассматривается в лаборатории. 

8. Щелкните **Просмотр и создание**, а затем нажмите кнопку **Создать**.

    >**Примечание.** Дождитесь завершения развертывания. Это может занять около 10 минут.

9. После завершения развертывания в портал Azure в **текстовом поле поиска, служб и документов** в верхней части страницы портал Azure введите +++Resource groups+++ и нажмите клавишу **ВВОД**.

10. В колонке **"Группы ресурсов" в списке групп** ресурсов обратите внимание на новую группу ресурсов с именем **MC_AZ500LAB09_MyKubernetesCluster_eastus** , которая содержит компоненты узлов AKS. Просмотрите ресурсы в этой группе ресурсов. 
    
11. Вернитесь к колонке **"Группы** ресурсов" и щелкните **запись AZ500LAB09** . 

    >**Примечание.** В списке ресурсов обратите внимание на кластер AKS и соответствующую виртуальную сеть.

12. В портал Azure откройте сеанс Bash в Cloud Shell. 

    >**Примечание.** Убедитесь, что **Bash** выбран в раскрывающемся меню в верхнем левом углу панели Cloud Shell.

13. В сеансе Bash в области Cloud Shell выполните следующее, чтобы подключиться к кластеру Kubernetes:

    ```sh
    az aks get-credentials --resource-group AZ500LAB09 --name MyKubernetesCluster
    ```

14. В сеансе Bash в области Cloud Shell выполните следующие действия, чтобы получить список узлов кластера Kubenetes: 

    ```sh
    kubectl get nodes
    ```

    >**Примечание.** Убедитесь, что **состояние** узла кластера указано как **готово**.

#### Задача 4. Предоставление кластеру AKS разрешений для доступа к ACR и управления своей виртуальной сетью

В этой задаче вы предоставьте кластеру AKS разрешение на доступ к ACR и управление его виртуальной сетью. 

1. В сеансе Bash в области Cloud Shell выполните следующую команду, чтобы настроить кластер AKS для использования экземпляра Реестр контейнеров Azure, созданного ранее в этой лаборатории. 

    ```sh
    ACRNAME=$(az acr list --resource-group AZ500LAB09 --query '[].{Name:name}' --output tsv)

    az aks update -n MyKubernetesCluster -g AZ500LAB09 --attach-acr $ACRNAME
    ```

    >**Примечание.** Эта команда предоставляет назначение роли acrpull ACR. 

    >**Примечание**. Выполнение этой команды может занять несколько минут. 

2. В сеансе Bash в области Cloud Shell выполните следующую команду, чтобы предоставить кластеру AKS роль участника своей виртуальной сети. 

    ```sh
    RG_AKS=AZ500LAB09

    RG_VNET=MC_AZ500LAB09_MyKubernetesCluster_eastus    

    AKS_VNET_NAME=aks-vnet-30198516
    
    AKS_CLUSTER_NAME=MyKubernetesCluster
    
    AKS_VNET_ID=$(az network vnet show --name $AKS_VNET_NAME --resource-group $RG_VNET --query id -o tsv)
    
    AKS_MANAGED_ID=$(az aks show --name $AKS_CLUSTER_NAME --resource-group $RG_AKS --query identity.principalId -o tsv)
    
    az role assignment create --assignee $AKS_MANAGED_ID --role "Contributor" --scope $AKS_VNET_ID
    ```

#### Задача 5. Развертывание внешней службы в AKS

В этой задаче вы скачайте файлы манифеста, измените файл YAML и примените изменения к кластеру. 

1. В сеансе Bash в области Cloud Shell щелкните **значок "Отправить и скачать файлы**" в раскрывающемся меню щелкните "Отправить **", **в **диалоговом окне "Открыть**" перейдите к расположению, где вы скачали файлы лаборатории, выберите\\** Allfiles Labs\\\\09\\nginxexternal.yaml** нажмите кнопку **"Открыть**". Затем выберите **Allfiles Labs\\\\09\\nginxinternal.yaml** и нажмите кнопку **"Открыть**".\\

2. В сеансе Bash в области Cloud Shell выполните следующие действия, чтобы определить имя экземпляра Реестр контейнеров Azure:

    ```sh
    echo $ACRNAME
    ```

    >**Примечание.** Запишите имя экземпляра Реестр контейнеров Azure. Вам потребуется позже в этой задаче.

3. В сеансе Bash в области Cloud Shell выполните следующую команду, чтобы открыть файл nginxexternal.yaml, чтобы изменить его содержимое. 

    ```sh
    code ./nginxexternal.yaml
    ```

    >**Примечание.** Это внешний ** yaml-файл.

    >**Примечание**. Если появится всплывающее окно **_"Переключиться на классическую облачную оболочку_**", нажмите кнопку **"Подтвердить**", выполните следующую команду и повторите этот шаг:

    ```sh
    ACRNAME=$(az acr list --resource-group AZ500LAB09 --query '[].{Name:name}' --output tsv)
    ```

4. В области редактора прокрутите вниз до **строки 24** и замените **`<ACRUniquename>`** заполнитель именем ACR.

5. В области редактора в правом верхнем углу щелкните значок многоточия **, нажмите кнопку "Сохранить **" и нажмите кнопку ****"Закрыть редактор**".** 

    >**Примечание.** Для сохранения файла и закрытия редактора можно использовать **ctrl+S** и **CTRL+Q** .

6. В сеансе Bash в области Cloud Shell выполните следующие действия, чтобы применить изменение к кластеру:

    ```sh
    kubectl apply -f nginxexternal.yaml
    ```

7. В сеансе Bash в области Cloud Shell просмотрите выходные данные команды, выполняемой в предыдущей задаче, чтобы убедиться, что развертывание и соответствующая служба были созданы. Вот что вы должны увидеть:

    ```
    deployment.apps/nginxexternal created
    service/nginxexternal created
    ```

#### Задача 6. Проверка доступа к внешней службе, размещенной в AKS

В этой задаче убедитесь, что контейнер можно получить внешне с помощью общедоступного IP-адреса.

1. В сеансе Bash в области Cloud Shell выполните следующую команду, чтобы получить сведения о службе nginxexternal, включая имя, тип, IP-адреса и порты. 

    ```sh
    kubectl get service nginxexternal
    ```

2. В сеансе Bash в области Cloud Shell просмотрите выходные данные и запишите значение в столбце External-IP. Они понадобятся вам на следующем шаге. 

3. Откройте новую вкладку браузера и перейдите к IP-адресу, который вы определили на предыдущем шаге.

4. Убедитесь, что добро пожаловать в **nginx!** отображается страница. 

#### Задача 7. Развертывание внутренней службы в AKS

В этой задаче вы развернете внутреннюю службу в AKS. 

1. В сеансе Bash в области Cloud Shell выполните следующую команду, чтобы открыть файл nginxintenal.yaml, чтобы изменить его содержимое. 

    ```sh
    code ./nginxinternal.yaml
    ```

    >**Примечание.** Это внутренний ** yaml-файл.

2. В области редактора прокрутите вниз до строки, содержащей ссылку на образ контейнера и замените **`<ACRUniquename>`** заполнитель именем ACR.

3. В области редактора в правом верхнем углу щелкните значок многоточия **, нажмите кнопку "Сохранить **" и нажмите кнопку ****"Закрыть редактор**".** 

    >**Примечание.** Для сохранения файла и закрытия редактора можно использовать **ctrl+S** и **CTRL+Q** .

4. В сеансе Bash в области Cloud Shell выполните следующие действия, чтобы применить изменение к кластеру:

    ```sh
    kubectl apply -f nginxinternal.yaml
    ```

5.  В сеансе Bash в области Cloud Shell просмотрите выходные данные, чтобы проверить развертывание и службу. Вот что вы должны увидеть:

    ```
    deployment.apps/nginxinternal created
    service/nginxinternal created
    ```

6. В сеансе Bash в области Cloud Shell выполните следующую команду, чтобы получить сведения о службе nginxinternal, включая имя, тип, IP-адреса и порты. 

    ```sh
    kubectl get service nginxinternal
    ```

7. В сеансе Bash в области Cloud Shell просмотрите выходные данные. Внешний IP-адрес в данном случае является частным IP-адресом. Если он находится в **состоянии ожидания** , выполните предыдущую команду еще раз.

    >**Примечание.** Запишите этот IP-адрес. Он понадобится в следующей задаче. 

    >**Примечание.** Чтобы получить доступ к внутренней конечной точке службы, вы будете интерактивно подключаться к одному из модулей pod, работающих в кластере. 

    >**Примечание.** Кроме того, можно использовать IP-адрес CLUSTER-IP.

#### Задача 8. Проверка доступа к внутренней службе, размещенной в AKS

В этой задаче вы будете использовать один из модулей pod, работающих в кластере AKS, для доступа к внутренней службе. 

1. В сеансе Bash в области Cloud Shell выполните следующие действия, чтобы вывести список модулей pod в пространстве имен по умолчанию в кластере AKS:

    ```sh
    kubectl get pods
    ```

2. В списке модулей pod скопируйте первую запись в столбце **NAME** .

    >**Примечание**. Это модуль pod, который будет использоваться в последующих шагах.

3. В сеансе Bash в области Cloud Shell выполните следующую команду, чтобы интерактивно подключиться к первому модулю pod (замените `<pod_name>` заполнитель именем, скопированным на предыдущем шаге):

    ```sh
    kubectl exec -it <pod_name> -- /bin/bash
    ```

4. В сеансе Bash в области Cloud Shell выполните следующую команду, чтобы убедиться, что веб-сайт nginx доступен через частный IP-адрес службы (замените `<internal_IP>` заполнитель IP-адресом, записанным в предыдущей задаче):

    ```sh
    curl http://<internal_IP>
    ```

5. Закройте область Cloud Shell.

> Результат. Вы настроили и обеспечили защиту ACR и AKS.


**Очистка ресурсов**

> Не забудьте удалить все новые ресурсы Azure, которые больше не используются. Удаление неиспользуемых ресурсов гарантирует, что вы не будете нести непредвиденные затраты.

1. В портал Azure откройте Cloud Shell, щелкнув первый значок в правом верхнем углу портала Azure. 

2. В раскрывающемся меню в левом верхнем углу области Cloud Shell выберите **PowerShell** и при появлении запроса нажмите кнопку **"Подтвердить**".

3. В сеансе PowerShell в области Cloud Shell выполните следующие действия, чтобы удалить группы ресурсов, созданные в этой лаборатории:
  
    ```powershell
    Remove-AzResourceGroup -Name "AZ500LAB09" -Force -AsJob
    ```

4. Убедитесь, что HTML-код **приветствия в nginx!** отображается страница.

5. Закройте область **Cloud Shell**. 
